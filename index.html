<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¬´ê³„íš ì—¬í–‰ ì¶”ì²œ (MVP)</title>
  <style>
    :root { --bg:#0b0e11; --panel:#141821; --ink:#e8eef6; --muted:#96a1b2; --accent:#7dd3fc; --accent2:#a78bfa; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Helvetica, Arial; background: linear-gradient(180deg,#0b0e11,#0f1220 40%,#0b0e11); color: var(--ink); }
    header { padding: 20px 16px; text-align: center; }
    header h1 { margin: 0 0 6px; font-size: clamp(22px,4vw,32px); letter-spacing: -0.3px; }
    header p { margin: 0; color: var(--muted); font-size: 14px; }
    .wrap { max-width: 1100px; margin: 10px auto 40px; padding: 0 16px 24px; display: grid; grid-template-columns: 420px 1fr; gap: 16px; }
    @media (max-width: 980px){ .wrap { grid-template-columns: 1fr; } }

    .card { background: linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.004)); border: 1px solid rgba(255,255,255,0.06); border-radius: 18px; box-shadow: 0 10px 24px rgba(0,0,0,0.25); }
    .pane { padding: 16px; }
    .pane h2 { margin: 0 0 14px; font-size: 18px; }
    .grid { display: grid; gap: 10px; }
    .row { display: grid; gap: 8px; }
    .row.inline { grid-template-columns: 1fr 1fr; gap: 8px; }
    label { font-size: 13px; color: var(--muted); }
    input[type="text"], input[type="number"], select { width: 100%; background: #0f1420; border: 1px solid rgba(255,255,255,0.08); color: var(--ink); padding: 10px 12px; border-radius: 10px; outline: none; }
    input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; background: linear-gradient(180deg,#1f2937,#111827); color: #eaf2ff; padding: 10px 14px; border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; cursor: pointer; text-decoration: none; font-weight: 600; }
    .btn:hover { filter: brightness(1.06); }
    .btn.primary { background: linear-gradient(180deg, #2ec7ff, #3b82f6); color: #041016; border-color: rgba(255,255,255,0.2); }
    .btn.alt { background: linear-gradient(180deg,#6ee7b7,#34d399); color: #062014; }
    .btn.small { font-size: 12px; padding: 6px 10px; }
    .flex { display:flex; align-items:center; gap:8px; }
    .stack { display:flex; flex-direction:column; gap:8px; }
    .muted { color: var(--muted); font-size: 12px; }
    .map { height: 520px; width: 100%; border-radius: 16px; overflow: hidden; }
    .result { display: grid; grid-template-columns: 1fr; gap: 8px; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,0.08); font-size:12px; color: var(--muted); }
    .k { color:#061015; background: linear-gradient(180deg,#a7f3d0,#34d399); }
    .links { display: grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 8px; }
    .links a { text-align:center; }
    .warning { color:#ffd6a6; font-size:12px; }
    footer { text-align:center; color:var(--muted); font-size:12px; padding:12px 0 20px; }
  </style>
  <!-- Kakao Map JS SDK: êµì²´ í•„ìˆ˜ -->
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=KAKAO_APP_KEY_HERE&libraries=services"></script>
</head>
<body>
  <header>
    <h1>ë¬´ê³„íš ì—¬í–‰ ì¶”ì²œ</h1>
    <p>í˜„ì¬ ìœ„ì¹˜ì™€ ê°„ë‹¨í•œ ì·¨í–¥ë§Œ ì„ íƒí•˜ë©´, ì£¼ë³€ì˜ ëœë¤ ì—¬í–‰ì§€ë¥¼ ë°”ë¡œ ì¶”ì²œí•´ë“œë ¤ìš”.</p>
  </header>

  <div class="wrap">
    <!-- ì™¼ìª½: ì»¨íŠ¸ë¡¤ -->
    <section class="card pane" id="controls">
      <h2>ì¡°ê±´ ì…ë ¥</h2>
      <div class="grid">
        <div class="row">
          <label>í˜„ì¬ ìœ„ì¹˜</label>
          <div class="flex">
            <button class="btn small" id="btnUseGPS">ğŸ“ í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°</button>
            <span class="muted" id="locText">ìœ„ì¹˜ ë¯¸í™•ì¸</span>
          </div>
        </div>

        <div class="row inline">
          <div>
            <label>ì°¨ëŸ‰ ì´ë™ ê°€ëŠ¥?</label>
            <select id="byCar">
              <option value="yes">ì˜ˆ</option>
              <option value="no">ì•„ë‹ˆì˜¤</option>
            </select>
          </div>
          <div>
            <label>ì´ë™ ê°€ëŠ¥ ê±°ë¦¬ (km)</label>
            <input id="maxKm" type="number" min="1" step="1" placeholder="ì˜ˆ: 50" />
          </div>
        </div>

        <div class="row inline">
          <div>
            <label>ì›í•˜ëŠ” ì»¨ì…‰</label>
            <select id="concept">
              <option value="auto" selected>ì•„ë¬´ê±°ë‚˜(ê·¼ì²˜ ê´€ê´‘ëª…ì†Œ)</option>
              <option value="mountain">ì‚°/ë“±ì‚°</option>
              <option value="sea">ë°”ë‹¤/í•´ë³€</option>
              <option value="lake">í˜¸ìˆ˜/ê°•</option>
              <option value="culture">ì „ì‹œ/ë¬¸í™”</option>
              <option value="park">ê³µì›/ì‚°ì±…</option>
            </select>
          </div>
          <div>
            <label>ëˆ„êµ¬ë‘?</label>
            <select id="withWho">
              <option value="solo">í˜¼ì</option>
              <option value="couple">ì»¤í”Œ</option>
              <option value="kids">ì•„ì´ë‘</option>
              <option value="family">ê°€ì¡±</option>
              <option value="friends">ì¹œêµ¬</option>
            </select>
          </div>
        </div>

        <div class="row">
          <label>ì†Œìš” ì‹œê°„</label>
          <select id="duration">
            <option value="day">ë‹¹ì¼</option>
            <option value="overnight">1ë°•</option>
          </select>
        </div>

        <div class="row">
          <button class="btn primary" id="btnRecommend">ğŸ² ëœë¤ ì—¬í–‰ì§€ ì¶”ì²œ ë°›ê¸°</button>
          <span class="muted">Tip: ì¡°ê±´ì„ ë°”ê¿”ê°€ë©° ì—¬ëŸ¬ ë²ˆ ë½‘ì•„ë³´ì„¸ìš”.</span>
        </div>

        <div class="row">
          <button class="btn" id="btnFood">ğŸ½ï¸ ì£¼ë³€ ë§›ì§‘ ëœë¤</button>
          <button class="btn" id="btnCafe">â˜• ì£¼ë³€ ì¹´í˜ ëœë¤</button>
          <span class="muted">ì—¬í–‰ì§€ ì„ íƒ í›„ í™œì„±í™”ë©ë‹ˆë‹¤.</span>
        </div>
      </div>

      <hr style="opacity:.12;margin:14px 0;"/>
      <div class="warning">â€» ë¸Œë¼ìš°ì € ìœ„ì¹˜ê¶Œí•œ í—ˆìš©ì´ í•„ìš”í•©ë‹ˆë‹¤. ì¶”ì²œ ê²°ê³¼ëŠ” ì¹´ì¹´ì˜¤ ì¥ì†Œ ë°ì´í„° ê¸°ë°˜ì´ë©°, ì‹¤ì œ ì˜ì—…/ì¶œì… ê°€ëŠ¥ ì—¬ë¶€ëŠ” í˜„ì¥ì—ì„œ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.</div>
    </section>

    <!-- ì˜¤ë¥¸ìª½: ê²°ê³¼/ì§€ë„ -->
    <section class="card pane">
      <div class="result" id="resultBox">
        <div>
          <div id="title" style="font-weight:800;font-size:18px;">ì—¬í–‰ì§€ë¥¼ ì¶”ì²œí•´ë“œë¦´ê²Œìš”</div>
          <div id="subtitle" class="muted">ì¡°ê±´ì„ ì…ë ¥í•˜ê³  ìƒë‹¨ì˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
        </div>
        <div class="grid" style="gap:6px;">
          <div class="pill">ê±°ë¦¬ <span id="distancePill"></span></div>
          <div class="pill">ë¶„ë¥˜ <span id="categoryPill"></span></div>
          <div class="pill">ì£¼ì†Œ <span id="addrPill"></span></div>
        </div>
        <div class="links" id="linkBox" style="margin-top:6px;">
          <a class="btn" id="naverCar" target="_blank" rel="noopener">ë„¤ì´ë²„ ìë™ì°¨ ê¸¸ì°¾ê¸°</a>
          <a class="btn" id="naverPublic" target="_blank" rel="noopener">ë„¤ì´ë²„ ëŒ€ì¤‘êµí†µ</a>
          <a class="btn" id="tmapCar" target="_blank" rel="noopener">í‹°ë§µ ê¸¸ì°¾ê¸°</a>
        </div>
      </div>
      <div class="pane">
        <div id="map" class="map"></div>
      </div>
    </section>
  </div>

  <footer>Â© 2025 ë¬´ê³„íš ì—¬í–‰ ì¶”ì²œ â€” Kakao Map ë°ì´í„° ê¸°ë°˜ MVP</footer>

  <script>
    // ===== Utilities ===== //
    const $ = sel => document.querySelector(sel);
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // meters
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c; // meters
    }

    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

    function fmtKm(m){ return (m/1000).toFixed(m>=2000?1:2) + ' km'; }

    // ===== App State ===== //
    const state = {
      user: { lat: 37.5665, lng: 126.9780, name: 'í˜„ì¬ ìœ„ì¹˜(ëŒ€ëµ)' }, // default ì„œìš¸ì‹œì²­ ê·¼ì²˜
      map: null,
      marker: null,
      places: null,
      selected: null,
    };

    // Kakao Places ì„œë¹„ìŠ¤ í•¸ë“¤ëŸ¬
    let placesService;

    // ===== Initialize Map ===== //
    function bootMap(){
      const container = document.getElementById('map');
      const options = { center: new kakao.maps.LatLng(state.user.lat, state.user.lng), level: 6 };
      state.map = new kakao.maps.Map(container, options);
      state.marker = new kakao.maps.Marker({ position: options.center });
      state.marker.setMap(state.map);
      placesService = new kakao.maps.services.Places();
    }

    // ===== Geolocation ===== //
    async function useGPS(){
      if(!navigator.geolocation){ alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
      $('#locText').textContent = 'ê°€ì ¸ì˜¤ëŠ” ì¤‘â€¦';
      navigator.geolocation.getCurrentPosition((pos)=>{
        const { latitude, longitude } = pos.coords;
        state.user.lat = latitude; state.user.lng = longitude; state.user.name = 'í˜„ì¬ ìœ„ì¹˜';
        $('#locText').textContent = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
        const latlng = new kakao.maps.LatLng(latitude, longitude);
        state.map.setCenter(latlng);
        state.marker.setPosition(latlng);
      }, (err)=>{
        alert('ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”. ('+ err.message +')\nì„œìš¸ì‹œì²­ìœ¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.');
        $('#locText').textContent = 'ìœ„ì¹˜ ë¯¸í™•ì¸';
      }, { enableHighAccuracy:true, timeout: 10000 });
    }

    // ===== Concept -> Kakao Query ===== //
    const conceptQueries = {
      auto: { type: 'category', value: 'AT4', keywords: [] }, // ê´€ê´‘ëª…ì†Œ ì¹´í…Œê³ ë¦¬
      mountain: { type: 'keyword', value: null, keywords: ['ë“±ì‚°ë¡œ','ì‚°ì±…ë¡œ','êµ­ë¦½ê³µì›','ì‚° ì „ë§ëŒ€','ì •ìƒ','ë‘˜ë ˆê¸¸'] },
      sea: { type: 'keyword', value: null, keywords: ['í•´ë³€','í•´ìˆ˜ìš•ì¥','í•­êµ¬','í¬êµ¬','í•´ì•ˆì‚°ì±…ë¡œ','ë°©íŒŒì œ'] },
      lake: { type: 'keyword', value: null, keywords: ['í˜¸ìˆ˜ê³µì›','í˜¸ìˆ˜','ê°•ë³€','ì„¬','ì„¬ë§ˆì„'] },
      culture: { type: 'keyword', value: null, keywords: ['ë°•ë¬¼ê´€','ë¯¸ìˆ ê´€','ì „ì‹œê´€','ë¬¸í™”ì¬','ì„±ê³½','í•œì˜¥ë§ˆì„'] },
      park: { type: 'keyword', value: null, keywords: ['ë„ì‹œê³µì›','ê·¼ë¦°ê³µì›','ìˆ˜ëª©ì›','ìƒíƒœê³µì›','ë‘˜ë ˆê¸¸'] },
    };

    function pickRadiusMeters(){
      const byCar = $('#byCar').value === 'yes';
      const kmInput = parseInt($('#maxKm').value || '0', 10);
      const duration = $('#duration').value; // day or overnight
      // ê¸°ë³¸ì¹˜ ì„¤ì •
      let km = byCar ? (duration==='day' ? 80 : 200) : (duration==='day' ? 25 : 60);
      if(kmInput > 0) km = kmInput;
      // Kakao Places radiusëŠ” ìµœëŒ€ 20000m (ë¬¸ì„œ ê¸°ì¤€) â€” ì•ˆì „í•˜ê²Œ 20kmì”© íƒ€ì¼ë§
      return Math.max(1000, Math.min(km * 1000, 20000));
    }

    function composeCandidateQueries(conceptKey){
      const c = conceptQueries[conceptKey];
      if(!c) return [];
      if(c.type === 'category') return [{ kind:'category', value:c.value }];
      const ks = c.keywords.length ? c.keywords : ['ê´€ê´‘ì§€'];
      return ks.map(k => ({ kind: 'keyword', value: k }));
    }

    function searchAround({ radius, conceptKey }){
      return new Promise(async (resolve) => {
        const list = [];
        const tasks = composeCandidateQueries(conceptKey).slice(0,6); // ê³¼ë„í•œ í˜¸ì¶œ ë°©ì§€
        let pending = tasks.length;
        const loc = new kakao.maps.LatLng(state.user.lat, state.user.lng);
        if(pending === 0){ resolve([]); return; }
        const cb = (data, status) => {
          if (status === kakao.maps.services.Status.OK && Array.isArray(data)) {
            for(const p of data){
              // Kakao JS PlacesëŠ” id í•„ë“œê°€ ìˆìŒ
              list.push(p);
            }
          }
          pending--; if(pending===0){ resolve(list); }
        };
        for(const q of tasks){
          if(q.kind==='category') { placesService.categorySearch(q.value, cb, { location: loc, radius }); }
          else { placesService.keywordSearch(q.value, cb, { location: loc, radius, sort: kakao.maps.services.SortBy.DISTANCE }); }
          await sleep(120); // ì‚´ì§ ê°„ê²© (í˜¸ì¶œ ì œí•œ ì—¬ìœ )
        }
      });
    }

    function uniqueById(arr){
      const m = new Map();
      for(const x of arr){ if(!m.has(x.id)) m.set(x.id, x); }
      return Array.from(m.values());
    }

    function chooseBest(cands){
      // ë‹¨ìˆœ ë¬´ì‘ìœ„ + withWhoì— ë”°ë¥¸ ê°€ë²¼ìš´ ê°€ì¤‘ì¹˜
      const who = $('#withWho').value;
      const keywords = {
        kids: ['ê³µì›','ê³¼í•™ê´€','ì²´í—˜','ë™ë¬¼ì›','í‚¤ì¦ˆ','ë°•ë¬¼ê´€'],
        couple: ['ì „ë§','ì•¼ê²½','ìŠ¤ì¹´ì´','í•´ë³€','ë‘˜ë ˆê¸¸','ì‚°ì±…'],
        solo: ['ì „ì‹œ','ì±…','ì„œì ','ì‚°ì±…','ë¯¸ìˆ ê´€'],
        family: ['ê³µì›','ì•¼ì™¸','ì²´í—˜','ë°•ë¬¼ê´€'],
        friends: ['ë¨¹ê±°ë¦¬','ì‹œì¥','í…Œë§ˆ','ëœë“œ'],
      }[who] || [];
      const score = p => {
        const name = (p.place_name||'') + ' ' + (p.category_name||'');
        let s = Math.random();
        for(const k of keywords){ if(name.includes(k)) s += 0.6; }
        return s;
      };
      return cands.sort((a,b)=>score(b)-score(a))[0];
    }

    function showSelection(p){
      state.selected = p;
      const lat = parseFloat(p.y), lng = parseFloat(p.x);
      const dist = haversine(state.user.lat, state.user.lng, lat, lng);
      $('#title').textContent = p.place_name || 'ì„ íƒëœ ì¥ì†Œ';
      $('#subtitle').textContent = (p.phone?`â˜ ${p.phone} Â· `:'') + (p.place_url? 'ìƒì„¸ë³´ê¸° ì—´ê¸°' : '');
      $('#distancePill').textContent = fmtKm(dist);
      $('#categoryPill').textContent = p.category_name || 'â€”';
      $('#addrPill').textContent = p.road_address_name || p.address_name || 'â€”';

      // ì§€ë„ ì´ë™ & ë§ˆì»¤ í‘œì‹œ
      const latlng = new kakao.maps.LatLng(lat, lng);
      state.map.setCenter(latlng);
      state.map.setLevel(5);
      state.marker.setPosition(latlng);

      // ê¸¸ì°¾ê¸° ë§í¬ êµ¬ì„±
      const sname = encodeURIComponent('í˜„ì¬ ìœ„ì¹˜');
      const dname = encodeURIComponent(p.place_name || 'ëª©ì ì§€');
      const appname = encodeURIComponent(location.origin.replace('http://','').replace('https://',''));
      const slat = state.user.lat, slng = state.user.lng, dlat = lat, dlng = lng;

      // ë„¤ì´ë²„ ì§€ë„ (ì•± ìŠ¤í‚´)
      const naverCar = `nmap://route/car?slat=${slat}&slng=${slng}&sname=${sname}&dlat=${dlat}&dlng=${dlng}&dname=${dname}&appname=${appname}`;
      const naverPublic = `nmap://route/public?slat=${slat}&slng=${slng}&sname=${sname}&dlat=${dlat}&dlng=${dlng}&dname=${dname}&appname=${appname}`;
      $('#naverCar').href = naverCar;
      $('#naverPublic').href = naverPublic;

      // í‹°ë§µ (ì•± ìŠ¤í‚´)
      const tmap = `tmap://route?startx=${slng}&starty=${slat}&goalx=${dlng}&goaly=${dlat}&goalname=${dname}&reqCoordType=WGS84&resCoordType=WGS84`;
      $('#tmapCar').href = tmap;
    }

    async function recommend(){
      if(!placesService){ alert('ì§€ë„ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'); return; }
      const conceptKey = $('#concept').value;
      const radius = pickRadiusMeters();
      const all = await searchAround({ radius, conceptKey });
      const unique = uniqueById(all)
        .filter(p => p.x && p.y)
        .map(p => ({...p, __dist: haversine(state.user.lat, state.user.lng, parseFloat(p.y), parseFloat(p.x)) }))
        .filter(p => p.__dist <= radius + 2000);
      if(unique.length === 0){ alert('ì¡°ê±´ì— ë§ëŠ” ì¥ì†Œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ê±°ë¦¬/ì»¨ì…‰ì„ ì¡°ì •í•´ë³´ì„¸ìš”.'); return; }
      shuffle(unique);
      const chosen = chooseBest(unique);
      showSelection(chosen);
    }

    async function nearbyFood(type){
      // type: 'FD6' (ìŒì‹ì ) | 'CE7' (ì¹´í˜)
      const p = state.selected; if(!p){ alert('ë¨¼ì € ì—¬í–‰ì§€ë¥¼ ì¶”ì²œë°›ì•„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
      const loc = new kakao.maps.LatLng(parseFloat(p.y), parseFloat(p.x));
      const radius = 1500; // 1.5km
      return new Promise((resolve)=>{
        placesService.categorySearch(type, (data, status)=>{
          if(status === kakao.maps.services.Status.OK){
            const picks = data.filter(x=>x.x && x.y);
            if(picks.length){
              shuffle(picks);
              const choice = picks[0];
              const msg = `${type==='FD6'?'ë§›ì§‘':'ì¹´í˜'} ëœë¤ ì¶”ì²œ: \n${choice.place_name}\n${choice.road_address_name || choice.address_name || ''}`;
              alert(msg);
            } else {
              alert('ì£¼ë³€ì—ì„œ ê²°ê³¼ê°€ ì—†ì–´ ë” ë„“ê²Œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.');
            }
          } else {
            alert('ê²€ìƒ‰ ì‹¤íŒ¨. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          }
          resolve();
        }, { location: loc, radius });
      });
    }

    // ===== Event Bindings ===== //
    window.addEventListener('DOMContentLoaded', ()=>{
      try { kakao.maps.load ? kakao.maps.load(bootMap) : bootMap(); } catch(e){ alert('Kakao ì§€ë„ ë¡œë“œ ì‹¤íŒ¨. App Keyë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'); }
      $('#btnUseGPS').addEventListener('click', useGPS);
      $('#btnRecommend').addEventListener('click', recommend);
      $('#btnFood').addEventListener('click', ()=>nearbyFood('FD6'));
      $('#btnCafe').addEventListener('click', ()=>nearbyFood('CE7'));
    });
  </script>
</body>
</html>
